<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<div class="cities">
  {% assign cities = site.data.cities %}
  {% assign total = cities | size %}

  <div class="cities-stats">
    <div class="cities-stat">
      <span class="stat-number">{{ total }}</span>
      <span class="stat-label">cities visited</span>
    </div>
  </div>

  <div id="cities-map" class="cities-map-container"></div>

  <div class="cities-list">
    <h3>All Cities</h3>
    <ul>
      {% for city in cities %}
      <li>
        <strong>{{ city.name }}</strong>
        <span class="city-country">({{ city.country }})</span>
        {% if city.visited %}<span class="city-date">- {{ city.visited }}</span>{% endif %}
        {% if city.notes %}<p class="city-notes">{{ city.notes }}</p>{% endif %}
      </li>
      {% endfor %}
    </ul>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var map = L.map('cities-map').setView([30, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var cities = [
      {% for city in site.data.cities %}
      {
        name: "{{ city.name }}",
        country: "{{ city.country }}",
        lat: {{ city.lat }},
        lng: {{ city.lng }},
        visited: "{{ city.visited }}",
        notes: "{{ city.notes | escape }}"
      }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    cities.forEach(function(city) {
      var popupContent = '<strong>' + city.name + '</strong>';
      if (city.country) popupContent += ' (' + city.country + ')';
      if (city.visited) popupContent += '<br>Visited: ' + city.visited;
      if (city.notes) popupContent += '<br><em>' + city.notes + '</em>';

      L.marker([city.lat, city.lng])
        .addTo(map)
        .bindPopup(popupContent);
    });

    // Fit bounds to show all markers
    if (cities.length > 0) {
      var group = L.featureGroup(cities.map(function(city) {
        return L.marker([city.lat, city.lng]);
      }));
      map.fitBounds(group.getBounds().pad(0.1));
    }
  });
</script>
